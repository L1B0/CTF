/*************************************************************************
	> File Name: exp.c
	> Author: l1b0 
	> Mail: ...
	> Created Time: 2019年11月30日 星期六 16时09分51秒
 ************************************************************************/

#include<stdio.h>
#include<string.h>
#include<stdlib.h>

#define ll unsigned long long
#define uc unsigned char


typedef struct result{
    ll v;
    unsigned char ss[4];
}res;

res result1[81450626], result2[81450626];



ll dword_4085E8[256] = {
    0x0, 0xB32E4CBE03A75F6F, 0xF4843657A840A05B, 0x47AA7AE9ABE7FF34, 0x7BD0C384FF8F5E33, 0xC8FE8F3AFC28015C, 0x8F54F5D357CFFE68, 0x3C7AB96D5468A107,
0xF7A18709FF1EBC66, 0x448FCBB7FCB9E309, 0x325B15E575E1C3D, 0xB00BFDE054F94352, 0x8C71448D0091E255, 0x3F5F08330336BD3A, 0x78F572DAA8D1420E, 0xCBDB3E64AB761D61,
0x7D9BA13851336649, 0xCEB5ED8652943926, 0x891F976FF973C612, 0x3A31DBD1FAD4997D, 0x64B62BCAEBC387A, 0xB5652E02AD1B6715, 0xF2CF54EB06FC9821, 0x41E11855055BC74E,
0x8A3A2631AE2DDA2F, 0x39146A8FAD8A8540, 0x7EBE1066066D7A74, 0xCD905CD805CA251B, 0xF1EAE5B551A2841C, 0x42C4A90B5205DB73, 0x56ED3E2F9E22447, 0xB6409F5CFA457B28,
0xFB374270A266CC92, 0x48190ECEA1C193FD, 0xFB374270A266CC9, 0xBC9D3899098133A6, 0x80E781F45DE992A1, 0x33C9CD4A5E4ECDCE, 0x7463B7A3F5A932FA, 0xC74DFB1DF60E6D95,
0xC96C5795D7870F4, 0xBFB889C75EDF2F9B, 0xF812F32EF538D0AF, 0x4B3CBF90F69F8FC0, 0x774606FDA2F72EC7, 0xC4684A43A15071A8, 0x83C230AA0AB78E9C, 0x30EC7C140910D1F3,
0x86ACE348F355AADB, 0x3582AFF6F0F2F5B4, 0x7228D51F5B150A80, 0xC10699A158B255EF, 0xFD7C20CC0CDAF4E8, 0x4E526C720F7DAB87, 0x9F8169BA49A54B3, 0xBAD65A25A73D0BDC,
0x710D64410C4B16BD, 0xC22328FF0FEC49D2, 0x85895216A40BB6E6, 0x36A71EA8A7ACE989, 0xADDA7C5F3C4488E, 0xB9F3EB7BF06317E1, 0xFE5991925B84E8D5, 0x4D77DD2C5823B7BA,
0x64B62BCAEBC387A1, 0xD7986774E864D8CE, 0x90321D9D438327FA, 0x231C512340247895, 0x1F66E84E144CD992, 0xAC48A4F017EB86FD, 0xEBE2DE19BC0C79C9, 0x58CC92A7BFAB26A6,
0x9317ACC314DD3BC7, 0x2039E07D177A64A8, 0x67939A94BC9D9B9C, 0xD4BDD62ABF3AC4F3, 0xE8C76F47EB5265F4, 0x5BE923F9E8F53A9B, 0x1C4359104312C5AF, 0xAF6D15AE40B59AC0,
0x192D8AF2BAF0E1E8, 0xAA03C64CB957BE87, 0xEDA9BCA512B041B3, 0x5E87F01B11171EDC, 0x62FD4976457FBFDB, 0xD1D305C846D8E0B4, 0x96797F21ED3F1F80, 0x2557339FEE9840EF,
0xEE8C0DFB45EE5D8E, 0x5DA24145464902E1, 0x1A083BACEDAEFDD5, 0xA9267712EE09A2BA, 0x955CCE7FBA6103BD, 0x267282C1B9C65CD2, 0x61D8F8281221A3E6, 0xD2F6B4961186FC89,
0x9F8169BA49A54B33, 0x2CAF25044A02145C, 0x6B055FEDE1E5EB68, 0xD82B1353E242B407, 0xE451AA3EB62A1500, 0x577FE680B58D4A6F, 0x10D59C691E6AB55B, 0xA3FBD0D71DCDEA34,
0x6820EEB3B6BBF755, 0xDB0EA20DB51CA83A, 0x9CA4D8E41EFB570E, 0x2F8A945A1D5C0861, 0x13F02D374934A966, 0xA0DE61894A93F609, 0xE7741B60E174093D, 0x545A57DEE2D35652,
0xE21AC88218962D7A, 0x5134843C1B317215, 0x169EFED5B0D68D21, 0xA5B0B26BB371D24E, 0x99CA0B06E7197349, 0x2AE447B8E4BE2C26, 0x6D4E3D514F59D312, 0xDE6071EF4CFE8C7D,
0x15BB4F8BE788911C, 0xA6950335E42FCE73, 0xE13F79DC4FC83147, 0x521135624C6F6E28, 0x6E6B8C0F1807CF2F, 0xDD45C0B11BA09040, 0x9AEFBA58B0476F74, 0x29C1F6E6B3E0301B,
0xC96C5795D7870F42, 0x7A421B2BD420502D, 0x3DE861C27FC7AF19, 0x8EC62D7C7C60F076, 0xB2BC941128085171, 0x192D8AF2BAF0E1E, 0x4638A2468048F12A, 0xF516EEF883EFAE45,
0x3ECDD09C2899B324, 0x8DE39C222B3EEC4B, 0xCA49E6CB80D9137F, 0x7967AA75837E4C10, 0x451D1318D716ED17, 0xF6335FA6D4B1B278, 0xB199254F7F564D4C, 0x2B769F17CF11223,
0xB4F7F6AD86B4690B, 0x7D9BA1385133664, 0x4073C0FA2EF4C950, 0xF35D8C442D53963F, 0xCF273529793B3738, 0x7C0979977A9C6857, 0x3BA3037ED17B9763, 0x888D4FC0D2DCC80C,
0x435671A479AAD56D, 0xF0783D1A7A0D8A02, 0xB7D247F3D1EA7536, 0x4FC0B4DD24D2A59, 0x3886B22086258B5E, 0x8BA8FE9E8582D431, 0xCC0284772E652B05, 0x7F2CC8C92DC2746A,
0x325B15E575E1C3D0, 0x8175595B76469CBF, 0xC6DF23B2DDA1638B, 0x75F16F0CDE063CE4, 0x498BD6618A6E9DE3, 0xFAA59ADF89C9C28C, 0xBD0FE036222E3DB8, 0xE21AC88218962D7,
0xC5FA92EC8AFF7FB6, 0x76D4DE52895820D9, 0x317EA4BB22BFDFED, 0x8250E80521188082, 0xBE2A516875702185, 0xD041DD676D77EEA, 0x4AAE673FDD3081DE, 0xF9802B81DE97DEB1,
0x4FC0B4DD24D2A599, 0xFCEEF8632775FAF6, 0xBB44828A8C9205C2, 0x86ACE348F355AAD, 0x34107759DB5DFBAA, 0x873E3BE7D8FAA4C5, 0xC094410E731D5BF1, 0x73BA0DB070BA049E,
0xB86133D4DBCC19FF, 0xB4F7F6AD86B4690, 0x4CE50583738CB9A4, 0xFFCB493D702BE6CB, 0xC3B1F050244347CC, 0x709FBCEE27E418A3, 0x3735C6078C03E797, 0x841B8AB98FA4B8F8,
0xADDA7C5F3C4488E3, 0x1EF430E13FE3D78C, 0x595E4A08940428B8, 0xEA7006B697A377D7, 0xD60ABFDBC3CBD6D0, 0x6524F365C06C89BF, 0x228E898C6B8B768B, 0x91A0C532682C29E4,
0x5A7BFB56C35A3485, 0xE955B7E8C0FD6BEA, 0xAEFFCD016B1A94DE, 0x1DD181BF68BDCBB1, 0x21AB38D23CD56AB6, 0x9285746C3F7235D9, 0xD52F0E859495CAED, 0x6601423B97329582,
0xD041DD676D77EEAA, 0x636F91D96ED0B1C5, 0x24C5EB30C5374EF1, 0x97EBA78EC690119E, 0xAB911EE392F8B099, 0x18BF525D915FEFF6, 0x5F1528B43AB810C2, 0xEC3B640A391F4FAD,
0x27E05A6E926952CC, 0x94CE16D091CE0DA3, 0xD3646C393A29F297, 0x604A2087398EADF8, 0x5C3099EA6DE60CFF, 0xEF1ED5546E415390, 0xA8B4AFBDC5A6ACA4, 0x1B9AE303C601F3CB,
0x56ED3E2F9E224471, 0xE5C372919D851B1E, 0xA26908783662E42A, 0x114744C635C5BB45, 0x2D3DFDAB61AD1A42, 0x9E13B115620A452D, 0xD9B9CBFCC9EDBA19, 0x6A978742CA4AE576,
0xA14CB926613CF817, 0x1262F598629BA778, 0x55C88F71C97C584C, 0xE6E6C3CFCADB0723, 0xDA9C7AA29EB3A624, 0x69B2361C9D14F94B, 0x2E184CF536F3067F, 0x9D36004B35545910,
0x2B769F17CF112238, 0x9858D3A9CCB67D57, 0xDFF2A94067518263, 0x6CDCE5FE64F6DD0C, 0x50A65C93309E7C0B, 0xE388102D33392364, 0xA4226AC498DEDC50, 0x170C267A9B79833F,
0xDCD7181E300F9E5E, 0x6FF954A033A8C131, 0x28532E49984F3E05, 0x9B7D62F79BE8616A, 0xA707DB9ACF80C06D, 0x14299724CC279F02, 0x5383EDCD67C06036, 0xE0ADA17364673F59
};

uc s[256] = {
0x5F, 0x5B, 0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x5F, 0x5F, 0x5F, 0x57, 0x65, 0x6C, 0x63, 0x6F, 0x6D,
0x65, 0x20, 0x54, 0x6F, 0x20, 0x52, 0x65, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6E, 0x67, 0x2E, 0x4B,
0x72, 0x5D, 0x5F, 0x5F, 0x54, 0x68, 0x65, 0x20, 0x69, 0x64, 0x65, 0x61, 0x20, 0x6F, 0x66, 0x20,
0x74, 0x68, 0x65, 0x20, 0x61, 0x6C, 0x67, 0x6F, 0x72, 0x69, 0x74, 0x68, 0x6D, 0x20, 0x63, 0x61,
0x6D, 0x65, 0x20, 0x6F, 0x75, 0x74, 0x20, 0x6F, 0x66, 0x20, 0x74, 0x68, 0x65, 0x20, 0x63, 0x6F,
0x64, 0x65, 0x65, 0x6E, 0x67, 0x6E, 0x20, 0x63, 0x68, 0x61, 0x6C, 0x6C, 0x65, 0x6E, 0x67, 0x65,
0x5F, 0x5F, 0x54, 0x68, 0x69, 0x73, 0x20, 0x61, 0x6C, 0x67, 0x6F, 0x72, 0x69, 0x74, 0x68, 0x6D,
0x20, 0x76, 0x65, 0x72, 0x79, 0x20, 0x46, 0x58, 0x43, 0x4B, 0x5F, 0x5F, 0x42, 0x75, 0x74, 0x20,
0x79, 0x6F, 0x75, 0x20, 0x63, 0x61, 0x6E, 0x20, 0x73, 0x6F, 0x6C, 0x76, 0x65, 0x20, 0x69, 0x74,
0x21, 0x21, 0x5F, 0x5F, 0x49, 0x6D, 0x70, 0x6F, 0x73, 0x73, 0x69, 0x62, 0x6C, 0x65, 0x20, 0x69,
0x73, 0x20, 0x49, 0x6D, 0x70, 0x6F, 0x73, 0x73, 0x69, 0x62, 0x6C, 0x65, 0x5F, 0x28, 0x29, 0x5F,
0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28,
0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D,
0xE7, 0x51, 0xDE, 0x35, 0xA3, 0x13, 0x90, 0x2E, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F,
0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28,
0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x5D, 0x5F, 0x28, 0x29, 0x5F, 0x5B, 0x00
};

uc reverse_i[256] = {
    0, 133, 143, 10, 155, 30, 20, 145, 179, 54, 60, 185, 40, 173, 167, 34, 102, 227, 233, 108, 253, 120, 114, 247, 213, 80, 90, 223, 78, 203, 193, 68, 73, 204, 198, 67, 210, 87, 93, 216, 250, 127, 117, 240, 97, 228, 238, 107, 47, 170, 160, 37, 180, 49, 59, 190, 156, 25, 19, 150, 7, 130, 136, 13, 146, 23, 29, 152, 9, 140, 134, 3, 33, 164, 174, 43, 186, 63, 53, 176, 244, 113, 123, 254, 111, 234, 224, 101, 71, 194, 200, 77, 220, 89, 83, 214, 219, 94, 84, 209, 64, 197, 207, 74, 104, 237, 231, 98, 243, 118, 124, 249, 189, 56, 50, 183, 38, 163, 169, 44, 14, 139, 129, 4, 149, 16, 26, 159, 36, 161, 171, 46, 191, 58, 48, 181, 151, 18, 24, 157, 12, 137, 131, 6, 66, 199, 205, 72, 217, 92, 86, 211, 241, 116, 126, 251, 106, 239, 229, 96, 109, 232, 226, 103, 246, 115, 121, 252, 222, 91, 81, 212, 69, 192, 202, 79, 11, 142, 132, 1, 144, 21, 31, 154, 184, 61, 55, 178, 35, 166, 172, 41, 182, 51, 57, 188, 45, 168, 162, 39, 5, 128, 138, 15, 158, 27, 17, 148, 208, 85, 95, 218, 75, 206, 196, 65, 99, 230, 236, 105, 248, 125, 119, 242, 255, 122, 112, 245, 100, 225, 235, 110, 76, 201, 195, 70, 215, 82, 88, 221, 153, 28, 22, 147, 2, 135, 141, 8, 42, 175, 165, 32, 177, 52, 62, 187
};

ll encrypt(ll k, uc pd[4])
{
    for(int i=0;i<4;i++)
    {
        s[i*16] = pd[i];
    }
    for(int i=0;i<64;i++)
    {
        uc t = (k&0xff)^s[i];
        k = k >> 8;
        k = k ^ dword_4085E8[t];
    }
    return k;
}

ll decrypt(ll k, uc pd[4])
{
    for(int i=0;i<4;i++)
    {
        s[i*16+64] = pd[i];
    }
    for(int i=255;i>=64;i--)
    {
        uc t = reverse_i[k>>56];

        k = k ^ dword_4085E8[t];
	    k = (k << 8) + (s[i]^t);
    }
    return k;
}

void test()
{
    ll k = 0xADAB87822F5AF097;
    for(int i=255;i>=113;i--)
    {
        uc t = reverse_i[k>>56];
        
        k = k ^ dword_4085E8[t];
        k = (k << 8 ) + (s[i]^t);
        printf("%d %u %llx\n",i,t,k);
    }
    return ;
}

ll testEncrypt(ll k, uc p[8])
{
    for(int i=0;i<8;i++)
    {
        s[i*16] = p[i];
    }
    for(int i=0;i<256;i++)
    {
        uc t = (k&0xff)^s[i];
        k = k >> 8;
        k = k ^ dword_4085E8[t];
    }
    return k;
}

int mycmp(const void *p1, const void *p2)
{
    res *a = (res*)p1;
    res *b = (res*)p2;
    //printf("%llx %llx\n",(long long)(a->v),(long long)(b->v));
    //printf("%d\n",(a->v)>(b->v));
    return (a->v)>(b->v);

}

int main()
{
    ll new_key = 0x5416B1679DB69FC3;
    ll fff = 0xFFFFFFFF;
    ll num = 0;

    //uc p[8]="12345678";
    //printf("%llx\n",testEncrypt(0,p));
    //printf("%d\n",decrypt(0xADAB87822F5AF097,p));
    //test();
    
    //FILE *fpWrite=fopen("result1.txt","w");  
    for(uc i=32;i<127;i++)
    {
        for(uc j=32;j<127;j++)
        {
            for(uc k=32;k<127;k++)
            {
                for(uc h=32;h<127;h++)
                {
                    uc p[4] = {i,j,k,h};
                    
                    printf("[e] %d\n",num);
                    
                    strcpy(result1[num].ss, p);
                    result1[num++].v = encrypt(0,p);
                    //fprintf(fpWrite,"%llx ",result1[num-1]);
                }
            }
        }
    }
    //fclose;
    qsort(result1, num, sizeof(res), mycmp);

    num = 0;
    //FILE *fpWrite=fopen("result2.txt","w");  
    for(uc i=32;i<127;i++)
    {
        for(uc j=32;j<127;j++)
        {
            for(uc k=32;k<127;k++)
            {
                for(uc h=32;h<127;h++)
                {
                    new_key = 0x676F5F675F695F6C;
                    uc p[4] = {i,j,k,h};

                    printf("[d] %d\n",num);
                    strcpy(result2[num].ss, p);
                    result2[num++].v = decrypt(new_key,p);
                    //fprintf(fpWrite,"%llx ",result2[num-1]);  
                }
            }
        }
    }
    //fclose(fpWrite);
    qsort(result2, num, sizeof(res), mycmp);

    int a=0, b=0;
    while( a < num && b < num )
    {
        printf("%llx %llx\n",result1[a].v,result2[b].v);
        if( result1[a].v == result2[b].v )
        {
            for(int i=0;i<4;i++)
                putchar(result1[a].ss[i]);
            for(int i=0;i<4;i++)
                putchar(result2[b].ss[i]);
            printf("\n");
            break;
        }
        else if( result1[a].v < result2[b].v ) a++;
        else b++;
    }

    return 0;
} 
